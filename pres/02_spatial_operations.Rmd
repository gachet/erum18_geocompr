---
title: "Tutorial: Geocomputation with R"
subtitle: "⚔<br>Spatial Operations"
author: "Jannes Muenchow, Robin Lovelace"
date: "ERUM Budapest, 2018-05-14"
output:
  xaringan::moon_reader:
    css: "raw/xaringan/my-theme.css"
    seal: true
    lib_dir: libs
    nature:
#      highlightStyle: dracula
      highlightLines: true
      ratio: '4:3'
      countIncrementalSlides: false
---

```{r setup, include = FALSE}
options(htmltools.dir.version = FALSE)
library(RefManageR)
BibOptions(check.entries = FALSE, 
           bib.style = "authoryear", 
           cite.style = 'alphabetic', 
           style = "markdown",
           first.inits = FALSE,
           hyperlink = FALSE, 
           dashed = FALSE)
my_bib = ReadBib("references.bib", check = FALSE)
```

layout: true
background-image: url(raw/xaringan/img/r_geocomp_background.png)
background-size: cover

---

# Find the slides and the code
<br>
<br>
<br>
<br>
https://github.com/jannes-m/erum18_geocompr

---
# Simple features in R
Simple feature access is a widely used [ISO standard](http://www.opengeospatial.org/standards/sfa).
--

```{r}
library("sf")
```

**sf** automatically links to [GEOS](https://trac.osgeo.org/geos/), [GDAL](http://www.gdal.org/) and [Proj.4](https://proj4.org/).

--
```{r}
data(random_points, package = "RQGIS")
class(random_points)
```
--

This is a **`data.frame`**, i.e, an S3 object (as opposed to `SpatialObjects`).

???
spatial databases, GIS, open source libraries, GeoJSON, GeoSPARQL, etc.
---

# Simple features in R
.pull-left[
```{r, eval=FALSE}
plot(random_points)
```
]

--

.pull-right[
```{r, echo=FALSE}
# see issue https://github.com/r-spatial/sf/issues/685
# -> update random_points!!
set_bb = function(x) { 
  class(attr(x[[attr(x, "sf_column")]], "bbox")) = "bbox"
  x 
  }
random_points = set_bb(random_points)
plot(random_points)
```
]
---

# Simple features in R
.pull-left[
```{r, eval=FALSE}
plot(
*  st_geometry(random_points),
  pch = 16, cex = 2,
  col = "black"
  bg = "lightblue"
  )
```
]

--

.pull-right[
```{r, echo=FALSE}
plot(st_geometry(random_points), pch = 21, cex = 2,
     col = "black", bg = "lightblue")
```
]
---
# Simple features in R

```{r, message=FALSE}
library("dplyr")
select(random_points, 1:2) %>%
  head(2)
```

A few things to note:
- **sf** works with the **tidyverse**.
--

- Geometry is **just** another column.
--

- The geometry column is **sticky**.

---
Things to note continued:
- Each observation (row) has a geometry (which can consist of multiple features, think of polygons with holes or multi-part polygons)
--

- The geometry column is a so-called **list-column**.
--

- The geometry is build up of **simple** R structures.

---

# Geometries

.pull-left[
.smaller-code-font75[
```{r, eval=FALSE}
# one point (a numeric vector)
*p = st_point(c(1.25, 1.25))
# one line (a matrix consisting of at
# least two points)
mat = matrix(c(1.5, 1.5, 1.7, 1.7),
             ncol = 2, byrow = TRUE)
*l = st_linestring(mat)
# one polygon
mat = matrix(c(1, 1, 1, 2, 2, 2, 
               2, 1, 1, 1), 
             ncol = 2, byrow = TRUE)
# a list of one or more matrices 
# consisting of points
*poly = st_polygon(list(mat))
# plot it
plot(poly)
plot(p, pch = 16, col = "blue",  
     cex = 2, add = TRUE)
plot(l, cex = 2, col = "orange", 
     lwd = 2, add = TRUE)
```
]
]

--

.pull-right[
```{r, echo=FALSE}
# one point (a numeric vector)
p = st_point(c(1.25, 1.25))
# one line (a matrix consisting of at least two points)
l = st_linestring(matrix(c(1.5, 1.5, 1.7, 1.7), ncol = 2, byrow = TRUE))
# one polygon
mat = matrix(c(1, 1, 1, 2, 2, 2, 2, 1, 1, 1), ncol = 2, byrow = TRUE)
# a list of one or more matrices consisting of points
poly = st_polygon(list(mat))
# plot it
plot(poly)
plot(p, pch = 16, col = "blue", cex = 2, add = TRUE)
plot(l, cex = 2, col = "orange", lwd = 2, add = TRUE)
```
]

--

???
Package sf puts features in sf tables deriving from data.frame or tbl_df, which have geometries in a list-column of class sfc, where each list element is a single feature’s geometry of class sfg. Feature geometries are represented in R by
- a numeric vector for a single point (POINT)
- a numeric matrix (each row a point) for a set of points (MULTIPOINT or LINESTRING)
- a list of matrices for a set of set of points (MULTIINESTRING, POLYGON)
- a list of lists of matrices (MULTIPOLYGON)
- a list of anything mentioned above (GEOMETRYCOLLECTION)
from: https://edzer.github.io/UseR2017/#a-short-history-of-handling-spatial-data-in-r
```{r, eval=FALSE}
# creating an sf-object manually
library("sf")
p = st_point(c(1, 1))
p_2 = st_point(c(1, 2))
pts = list(p, p_2)
pts = st_sfc(pts, crs = 4326)
pts = st_sf(data.frame("id" = 1:2, "geometry" = pts))
# or using the "tidy" way
pts = list(p, p_2) %>%
  st_sfc(crs = 4326) %>%
  st_sf(data.frame("id" = 1:2), geometry = .)
```
---

# Putting it all together
**sf** uses three classes to represent simple features in R:

- `sf` is the `data.frame` with the attributes and the list-column
--

- The list column is of class `sfc`.

```{r} 
lc = random_points %>%
  st_geometry
class(lc)
```
--

- Each feature of the list column is of class `sfg`.

```{r}
class(lc[[1]])
```
--

For more information, refer to `vignette("sf1", package = "sf")` and [https://geocompr.robinlovelace.net/spatial-class.html#vector-data](https://geocompr.robinlovelace.net/spatial-class.html#vector-data)
---

# Attribute operations
- `sf` objects are basically dataframes and thus can be handled like any other R object.

--

```{r}
dim(random_points)
```
--

```{r} 
str(random_points)
```
---

# Subsetting

```{r}
# first 2 rows and first 2 columns
random_points[1:2, 1:2]
```
---

# Tidyverse
- When **dplyr** is also attached to the global environment, a number of generic methods of the tidyverse become available for `sf`-objects, most notably the one-table verbs `select`, `slice`, `filter`, `arrange`, `mutate`, `summarize` (and `group_by`).
--

- Piped operations are also supported (`%>%`).
--

```{r}
select(random_points, 1:2) %>%
  slice(1:2)
```

???
```{r}
m1 = attr(methods(class = "sf"), "info")$generic
library(tidyverse)
m2 = attr(methods(class = "sf"), "info")$generic
noquote(setdiff(m2, m1))
```


# Spatial operations
- Spatial subsetting
- Topological or neighborhood operations
- Spatial joins (spatial overlay)
---

# Geometric operations

---

# Little exercise


---

# Raster data in R

---